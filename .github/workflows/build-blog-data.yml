name: Build blog data

on:
  workflow_dispatch:
  # Uncomment to trigger after your main data pipeline:
  # workflow_run:
  #   workflows: ["Update data"]
  #   types: [completed]

permissions:
  contents: read
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: arrow, dplyr

      - name: Download source parquets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p source
          for fmt in t20 odi test; do
            gh release download player_rating -p "${fmt}_player_skill.parquet" -D source
            gh release download team_rating   -p "${fmt}_team_skill.parquet"   -D source
            gh release download venue_rating  -p "${fmt}_venue_skill.parquet"  -D source
          done

      - name: Aggregate
        run: Rscript scripts/build_blog_data.R

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Upload to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_R2_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          npm install -g wrangler
          shopt -s nullglob
          files=(blog/*.parquet)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No parquet files found in blog/ â€” skipping upload"
            exit 0
          fi
          for f in "${files[@]}"; do
            wrangler r2 object put "inthegame-data/$(basename "$f")" --file "$f" --remote
          done

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Build Blog Data Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Workflow Failure

            The build-blog-data workflow failed.

            - **Run ID**: ${{ github.run_id }}
            - **Run URL**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - **Triggered by**: ${{ github.event_name }}

            Please check the workflow logs for details.
            `;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure'
            });

            const today = new Date().toISOString().split('T')[0];
            const existingIssue = issues.data.find(i => i.title.includes(today) && i.title.includes('Blog'));

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['workflow-failure']
              });
            }
